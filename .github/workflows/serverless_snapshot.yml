name: Serverless snapshot 
on:
  # Allows you to run this workflow manually from the Actions tab for testing
  workflow_dispatch:

  repository_dispatch:
    types: [serverless_snapshot]


concurrency: 
  group: ${{ github.workflow }}
  cancel-in-progress: false


jobs:
  run-data-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        # the source code is in this branch, but had to put GHA yaml
        # in main because workflow dispatch endpoint onnly allows
        # triggering workflows on default branch.
        # https://docs.github.com/en/actions/reference/workflows-and-actions/events-that-trigger-workflows#workflow_dispatch
        with:
          ref: incremental_run_gha

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: install project deps 
        run: uv sync

      - name: trigger extraction
        run: uv run ticktick_fetcher.py
        env:
          TICKTICK_API_KEY: ${{ secrets.TICKTICK_API_KEY }}
          

      - name: Load remote state to duckdb ðŸ¦†
        run: uv run dbt build
        env:
          DBT_PROFILES_DIR: .
          GCS_KEY: ${{ secrets.GCS_KEY }}
          GCS_SECRET: ${{ secrets.GCS_SECRET }}
          DBT_TARGET: "load_snapshot"
          GCS_RAW_BUCKET: ${{ secrets.GCS_RAW_BUCKET }}

          
      - name: Snapshot and dump to GCS ðŸª£
        run: uv run dbt build
        env:
          DBT_PROFILES_DIR: .
          GCS_KEY: ${{ secrets.GCS_KEY }}
          GCS_SECRET: ${{ secrets.GCS_SECRET }}
          DBT_TARGET: "dump_snapshot"
          GCS_RAW_BUCKET: ${{ secrets.GCS_RAW_BUCKET }}
